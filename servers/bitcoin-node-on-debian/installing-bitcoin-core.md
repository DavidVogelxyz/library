# Installing Bitcoin Core

[Back to the home page](README.md)

## Table of contents

- [Introduction](#introduction)
- [Bitcoin Core](#bitcoin-core)
    - [Configuring Bitcoin Core](#configuring-bitcoin-core)
    - [Checking on Bitcoin Core during the intial sync](#checking-on-bitcoin-core-during-the-intial-sync)
    - [Re-configuring Bitcoin Core after the initial sync](#re-configuring-bitcoin-core-after-the-initial-sync)
- [References](#references)

## Introduction

Bitcoin Core is a client software that allows the server to download and host a complete (or pruned) instance of the Bitcoin timechain. This section of the guide will describe how to configure and install Bitcoin Core.

## Bitcoin Core

The first step to installing Bitcoin Core is to download the installation files.

Change directory to the `/tmp` directory, so the files don't clutter the system:

```
cd /tmp
```

Next, grab the [download links](https://bitcoincore.org/en/download/) to the corresponding files, and download them using `curl -LJO`.

Note: `$VERSION` represents the current Bitcoin Core version (27.1, as of writing), and `$ARCHITECTURE` represents the CPU architecture (`x86_64` for laptops, and `aarch64` for Raspberry Pi). These can be set as variables, in the following way:

```
VERSION="27.1"
ARCHITECTURE="x86_64"
```

First, download the package archive:

```
curl -LJO https://bitcoincore.org/bin/bitcoin-core-$VERSION/bitcoin-$VERSION-$ARCHITECTURE-linux-gnu.tar.gz
```

Next, download the list of hashes for the binary archives:

```
curl -LJO https://bitcoincore.org/bin/bitcoin-core-$VERSION/SHA256SUMS
```

Finally, download the GPG signatures for those hashes:

```
curl -LJO https://bitcoincore.org/bin/bitcoin-core-$VERSION/SHA256SUMS.asc
```

Now, run a SHA256 checksum verification on the Bitcoin Core archive with the following:

```
sha256sum --ignore-missing --check SHA256SUMS
```

Next, grab the public keys (pubkeys) of the Bitcoin Core maintainers to verify the validity of the signatues:

```
curl -s "https://api.github.com/repositories/355107265/contents/builder-keys" | grep download_url | grep -oE "https://[a-zA-Z0-9./-]+" | while read url; do curl -s "$url" | gpg --import; done
```

Now that the pubkeys have been added to the GPG keyring, verify the `SHA256SUMS.asc` file:

```
gpg --verify SHA256SUMS.asc
```

With the signatures verified, it is now time to extract the compressed Bitcoin Core archive:

```
tar -xvf bitcoin-$VERSION-$ARCHITECTURE-linux-gnu.tar.gz
```

Install the extracted files into `/usr/local/bin` directory:

```
sudo install -m 0755 -o root -g root -t /usr/local/bin bitcoin-$VERSION/bin/*
```

Confirm that the binary has been installed correctly by running the following command:

```
bitcoin-cli --version
```

## Configuring Bitcoin Core

Now that Bitcoin Core is installed, create a new user to manage the Bitcoin service:

```
sudo useradd -G debian-tor -s /bin/bash -m bitcoin
```

Note that the `-G` option directs the `bitcoin` user to be added to the `debian-tor` group upon creation, and the `-s` option changes the user's default shell to `/bin/bash`. The `-m` option directs the command to create a home directory for the new user.

Next, add the main admin user to the `bitcoin` group, so the user can manage the Bitcoin service as well:

```
sudo usermod -aG bitcoin <USERNAME>
```

To confirm the change, check the groups of that user:

```
groups <USERNAME>
```

Next, create a `/data/bitcoin` directory in `/data`:

```
mkdir -pv /data/bitcoin
```

Change the ownership of that new directory so that the `bitcoin` user owns the directory and its contents:

```
sudo chown -R bitcoin: /data/bitcoin
```

Switch users to the `bitcoin` user:

```
sudo su - bitcoin
```

Now, create a symbolic link so that all Bitcoin Core configuration files are accessible from the `/data/bitcoin` directory:

```
ln -s /data/bitcoin ~/.bitcoin
```

Next, change directory into the `~/.bitcoin` directory and download a Python file that will allow the user to generate a cookie file, for authentication purposes:

```
cd ~/.bitcoin && curl -LJO https://raw.githubusercontent.com/bitcoin/bitcoin/master/share/rpcauth/rpcauth.py
```

Now, create the new file `~/.bitcoin/bitcoin.conf` and add the following content to it:

```
# <HOSTNAME>: bitcoind configuration
# /home/bitcoin/.bitcoin/bitcoin.conf

# Bitcoin daemon
server=1
txindex=1

# Allow creation of legacy wallets (required for JoinMarket)
deprecatedrpc=create_bdb

# Network
listen=1
listenonion=1
proxy=127.0.0.1:9050
bind=127.0.0.1

# Activate v2 P2P
v2transport=1

# Connections
rpcauth=<replace with authentication hash generated by rpcauth.py in the next step>
zmqpubrawblock=tcp://127.0.0.1:28332
zmqpubrawtx=tcp://127.0.0.1:28333
whitelist=download@127.0.0.1        # for Electrs

# Mempool
#maxmempool=1000

# Raspberry Pi optimizations
#maxconnections=40
#maxuploadtarget=5000

# Initial block download optimizations
dbcache=2000
blocksonly=1
```

Note that `<HOSTNAME>` should be the hostname of the node, and `rpcauth` will be generated in the following step.

Now, generate the authentication hash for the `rpcauth` line of the "bitcoin.conf" file.

Since the `bitcoin` user is running `bash` as the default shell, use the following command with a space in front of it, so that the command is not saved into the command history. For reference, `<USERNAME>` is the username of the main admin account being used, and `<PASSWORD>` is a new password created for securing the Bitcoin Core RPC client.

```
 python3 rpcauth.py <USERNAME> <PASSWORD>
```

Copy the line generated by the python script and add it to the `bitcoin.conf` file, in place of the existing `rpcauth` line.

Next, change the permissions of the `bitcoin.conf` file, so only the `bitcoin` user and members of the `bitcoin` group can read it:

```
chmod 640 ~/.bitcoin/bitcoin.conf
```

With all of this completed, test the Bitcoin Core install by running the Bitcoin daemon:

```
bitcoind
```

After a minute or so, it should be clear whether or not `bitcoind` is running as intended. Stop the process for now.

Next, change permissions on the `debug.log` file:

```
chmod g+r /data/bitcoin/debug.log
```

Log out of the `bitcoin` user, and back to the main admin user. Symlink the `/data/bitcoin` directory into the main user's directory:

```
ln -s /data/bitcoin ~/.bitcoin
```

Now, create a `bitcoind` service file, so that the `bitcoind` process will run automatically when the node reboots:

```
sudo vim /etc/systemd/system/bitcoind.service
```

Add the following content to the new file:

```
# <HOSTNAME>: systemd unit for bitcoind
# /etc/systemd/system/bitcoind.service

[Unit]
Description=Bitcoin daemon
After=network.target

[Service]

# Service execution
###################

ExecStart=/usr/local/bin/bitcoind -daemon \
                                  -pid=/run/bitcoind/bitcoind.pid \
                                  -conf=/home/bitcoin/.bitcoin/bitcoin.conf \
                                  -datadir=/home/bitcoin/.bitcoin \
                                  -startupnotify="chmod g+r /home/bitcoin/.bitcoin/.cookie"

# Process management
####################
Type=forking
PIDFile=/run/bitcoind/bitcoind.pid
Restart=on-failure
TimeoutSec=300
RestartSec=30

# Directory creation and permissions
####################################
User=bitcoin
UMask=0027

# /run/bitcoind
RuntimeDirectory=bitcoind
RuntimeDirectoryMode=0710

# Hardening measures
####################
# Provide a private /tmp and /var/tmp.
PrivateTmp=true

# Mount /usr, /boot/ and /etc read-only for the process.
ProtectSystem=full

# Disallow the process and all of its children to gain
# new privileges through execve().
NoNewPrivileges=true

# Use a new /dev namespace only populated with API pseudo devices
# such as /dev/null, /dev/zero and /dev/random.
PrivateDevices=true

# Deny the creation of writable and executable memory mappings.
MemoryDenyWriteExecute=true

[Install]
WantedBy=multi-user.target
```

Again, `<HOSTNAME>` should be the hostname of the node.

Enable this new service with the following command:

```
systemctl enable bitcoind
```

To confirm that everything is working as intended, reboot the node:

```
reboot now
```

After logging back into the node, confirm that the `bitcoind` service is running with the following:

```
systemctl status bitcoind
```

In addition, confirm the permissions for the Bitcoin "cookie" file are `640` (`r+w` for the user, and `r` for the group):

```
ls ~/.bitcoin/.cookie
```

With `bitcoind` now running as intended, let the process run for a few days (potentially, up to about a week) in order to complete the initial sync.

## Checking on Bitcoin Core during the intial sync

While waiting, there are a few ways to get information about the Initial Blockchain Download (IBD). One way is to use the following command:

```
bitcoin-cli getblockchaininfo
```

This command gives a lot of output about the current status of the initial sync. It can be very useful, but is sometimes too verbose for a more seasoned node-runner.

Another way to check the status of the initial sync is with the following command:

```
tail -f ~/.bitcoin/debug.log
```

This command will use `tail` to check the last lines of the Bitcoin Core log file. The `-f` option represents "follow", and tells `tail` to continue to read the last lines until cancelled. Again, very useful, but sometimes too verbose.

The best way to query the process is with the following:

```
bitcoin-cli getblockchaininfo | grep blocks
```

This command will only output the line from `bitcoin-cli getblockchaininfo` that indicates the current block header. This is a quick way for someone who knows the current block height to get an idea of how far away their node is from syncing.

## Re-configuring Bitcoin Core after the initial sync

Once Bitcoin Core has completed its initial sync, be sure to edit the `bitcoin.conf` file to make the following adjustments.

First, uncomment the following line:

```
# Mempool
#maxmempool=1000
```

Next, comment out the following two lines:

```
# Initial block download optimizations
dbcache=2000
blocksonly=1
```

To push these changes, restart the `bitcoind` service:

```
systemctl restart bitcoind
```

Congrats on syncing Bitcoin Core! The next step is to install a transaction indexer to make use of other Bitcoin services, such as wallet software and timechain explorers.

## References

- [Raspibolt - Bitcoin Client](https://raspibolt.org/guide/bitcoin/bitcoin-client.html)
    - Reference for initial setup of the Bitcoin Core client.
