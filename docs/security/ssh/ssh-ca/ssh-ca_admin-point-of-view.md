The admin's point of view
=========================

[Back to the home page](README.md)

[Back to the previous page](ssh-ca_user-point-of-view.md)

Table of contents
-----------------

- [Introduction](#introduction)
- [Infrastructure](#infrastructure)
- [The master_site_key](#the-master_site_key)

Introduction
------------

A well-configured SSH certificate authority is, in fact, a collection of two CAs, each governing a separate part of the **authentication** and **verification** process. An SSH certificate authority is simply an SSH keypair that has been designated for a specified function -- it is no different than any other SSH keypair, other than its use case.

The first CA introduced was `host-CA_key`, the host certificate authority keypair. The other CA that should be configured is the `user-CA_key`, the user certificate authority keypair.

As described earlier, the `host-CA_key` is responsible for signing the `host-CA_cert.pub`, which can be shared with users to be added to their `known_hosts` file. The `host-CA_key` enables **verification, by the user, of the host**.

The `user-CA_key` is responsible for signing user pubkeys to create user certificates. In contrast to the `host-CA_key`, the `user-CA_key` enables **authentication of the user, by the host**.

Infrastructure
--------------

The admin team is responsible for the creation and safe-guarding of two SSH CA keypairs, the `host-CA_key` and the `user-CA_key`.

The `host-CA_key` private key will be used immediately to sign the `host-CA_key`'s pubkey, creating the `host-CA_cert.pub`. This is the certificate that will be shared with users to be appended to their `known_hosts` file. The `host-CA_key` will also be used to sign host certificates for every host within the SSH certificate authority. It is the interaction of the users' `host-CA_cert` (the entry in the `known_hosts` file) and the hosts' certificates that makes the host CA work.

The `user-CA_key`, on the other hand, does not generate a `user-CA_cert.pub`. Instead, the `user-CA_key` pubkey should be shared with all hosts. This is how the hosts know that they should accept certificates signed by the `user-CA_key` private key. The `user-CA_key` will also be used to sign user certificates for every user within the SSH certificate authority. Similar to the host CA, it is the interaction of the hosts' `user-CA_key` pubkey and the users' certificates that makes the user CA work.

The `user-CA_key` will be used more frequently, in order to generate and revoke user certificates; in contrast, the `host-CA_key` will generally only be used when new hosts are being added to the site.

For maximum completion, there are even more keypairs of which the admin team should be aware! These keypairs are the "host keypairs".

As an example, look within the `/etc/ssh` directory of a host, and there will exist SSH keypairs. These are the keypairs that generate the "the authenticity of host can't be established" messages. Signing the pubkeys found within `/etc/ssh` with the `host-CA_key` will create host certificates for those keypairs. Adding these host certificates to the hosts' `/etc/ssh` directories will enable user verification of the host.

**NB:** There is nothing special about the SSH keypairs that were autogenerated by the hosts when the `sshd` daemon was first started. If desired, these keypairs can be deleted in favor of SSH host keypairs that are generated by the admin team. Bonus points are granted if Ansible is used to orchestrate the management and deployment of these keys.

Therefore, a serious admin team would have to manage the following infrastructure:
- The `host-CA_key`, and everything downstream:
    - The associated `host-CA_cert.pub`, for **host verification**
    - The host pubkeys (and, potentially, the host private keys)
    - The host certificates, also for **host verification**, generated by the `host-CA_key` and the host pubkeys
- The `user-CA_key`, and everything downstream:
    - The `user-CA_key` pubkey, for **user authentication**
    - The user pubkeys shared with the admin team (for potential revocation)
    - The user certificates, also for **user authentication**, generated by the `user-CA_key` and the user pubkeys
- The `master_site_key`

The master_site_key
-------------------

Referring back to the [original example](getting-started-with-ssh-ca.md#thought-experiment) of `admin@mediaserver`'s simplified `authorized_keys` file, a keypair was introduced: the `master_site_key`. As with "Checkov's gun", the `master_site_key` was referenced for a reason. It has an essential function -- it is a failsafe.

If there ever was an instance where all user certificates expired (including all admin certificates), then the `master_site_key` is a keypair that the admin team could use to regain access to the servers in order to renew the SSH certificate authority infrastructure.

[Next page](configure-ssh-ca.md)
