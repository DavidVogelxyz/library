Configuration of a SSH certificate authority
============================================

[Back to the home page](README.md)

[Back to the previous page](ssh-ca_admin-point-of-view.md)

Table of contents
-----------------

- [Introduction](#introduction)
- [Generating SSH keypairs](#generating-ssh-keypairs)
- [Configuring a host](#configuring-a-host)
- [Configuring a user](#configuring-a-user)
- [Signing certificates with CA keys](#signing-certificates-with-ca-keys)
    - [Signing a host certificate](#signing-a-host-certificate)
    - [Signing a user certificate](#signing-a-user-certificate)
- [Conclusion](#conclusion)

Introduction
------------

Now that the SSH certificate authority makes sense, it's time to set one up.

Generating SSH keypairs
-----------------------

All SSH keypairs; whether for the CAs, hosts, or users; can be generated with the following command:

```bash
ssh-keygen -t ed25519 -C "<COMMENT>"
```

The `<COMMENT>` can be any string that is useful for the management of the CA and relevant activity. As described in previous sections, useful comments may be:
- Host CA key:
    - `host-CA_key`
- User CA key:
    - `user-CA_key`
- Master site key:
    - `master_site_key`
- Example host key:
    - `gitlab`
- Example user key:
    - `George.Washington`

Configuring a host
------------------

Any host that will be attuned to the CA must have the following:
- The host SSH keypair, often located in the `/etc/ssh` directory
    - The private key is the more critical of the two keys, as it has to interact with the host certificate for verification.
    - While not essential, there is no reason **NOT** to keep the pubkey with its private key.
- The host certificate, also located in the `/etc/ssh` directory
    - The host certificate is essential for host verification by the user.
- The `user-CA_key.pub`, also located in the `/etc/ssh` directory
    - The user CA pubkey is essential for user authentication by the host.

In addition, the following lines should be present in the `/etc/ssh/sshd_config` file:

```
TrustedUserCAKeys       <PATH_TO_USER-CA_PUBKEY.PUB>
HostKey                 <PATH_TO_HOST_PRIVATE_KEY>
HostCertificate         <PATH_TO_HOST_CERT>
```

As an "admin team" security measure, the hosts should all have at least one user with an `authorized_keys` file configured to accept the `master_site_key`. This is especially beneficial if/when rotating the `user-CA` keypair, as all user certificates generated by the original `user-CA` keypair will cease to work. That being said, it's also possible to have multiple `TrustedUserCAKeys`, `HostKey`, and `HostCertificate` entries in the `/etc/ssh/sshd_config` file. As best practice, **implement at least one safety measure**!

Configuring a user
------------------

Any user that will be attuned to the CA must have the following:
- Their user SSH keypair
- Their user certificate
- The `host-CA_cert.pub`, as an entry in their `known_hosts` file

This guide suggests that the user create a `~/.ssh/config` file with an entry similar to the following:

```
Host mediaserver
    HostName            mediaserver
    User                admin
    IdentityFile        <PATH_TO_PRIVATE_KEY>
    CertificateFile     <PATH_TO_USER_CERT>
```

Signing certificates with CA keys
---------------------------------

### Signing a host certificate

Signing a host certificate is the same whether creating a host CA certificate, or a host certificate. The command will look similar to the following:

```bash
ssh-keygen -s "<SIGNING_PRIVATE_KEY>" -h -I "<IDENTITY>" -V "-5m:+<PERIOD>w" "<PUBKEY_HOST>"
```

Breaking this command down:
- The `ssh-keygen` command, run to create keypairs, is also run to sign certificates
- `-s "<SIGNING_PRIVATE_KEY>"` instructs `ssh-keygen` to sign the certificate with `<SIGNING_PRIVATE_KEY>`:
    - `<SIGNING_PRIVATE_KEY>` should be the private key for the `host-CA_key` keypair
- `-h` instructs `ssh-keygen` to create a host certificate
- `-I "<IDENTITY>"` instructs `ssh-keygen` to give the certificate the identity `<IDENTITY>`:
    - The `<IDENTITY>` is no different than the `<COMMENT>` set during [SSH keypair generation](#generating-ssh-keypairs):
        - `<IDENTITY>` can be any valid string; but, be sure to create a useful comment
- `-V "-5m:+<PERIOD>w"` instructs `ssh-keygen` to set a time period for which the certificate is valid:
    - `-5m:+<PERIOD>w` will create a certificate that's valid from 5 minutes into the past until the specified number of weeks into the future:
        - `m` is the abbreviation for minutes, and `w` is the unit abbreviation for "weeks"; but, these are not the only units that can be used
- `<PUBKEY_HOST>` is the host pubkey that will be combined with `<SIGNING_PRIVATE_KEY>`'s signature:
    - For the host CA certificate, `<PUBKEY_HOST>` is the pubkey for the `host-CA_key` keypair
    - For any other host certificate, `<PUBKEY_HOST>` is the pubkey for that host's keypair
    - `<PUBKEY_HOST>` is the first argument not associated with an option or flag:
        - Because of this, any number of `<PUBKEY_HOST>`s can be added to the end of the command, and `ssh-keygen` will sign certificates for all `<PUBKEY_HOST>` values passed as arguments.

### Signing a user certificate

Signing a user certificate is the same whether creating a user CA certificate, or a user certificate. The command will look similar to the following:

```bash
ssh-keygen -s "<SIGNING_PRIVATE_KEY>" -n "<USER_LIST>" -I "<IDENTITY>" -V "+<PERIOD>w" "<PUBKEY_USER>"
```

Breaking this command down:
- The `ssh-keygen` command, run to create keypairs, is also run to sign certificates
- `-s "<SIGNING_PRIVATE_KEY>"` instructs `ssh-keygen` to sign the certificate with `<SIGNING_PRIVATE_KEY>`:
    - `<SIGNING_PRIVATE_KEY>` should be the private key for the `user-CA_key` keypair
- `-n "<USER_LIST>"` instructs `ssh-keygen` to only allow access to the usernames specified:
    - `<USER_LIST>` is a comma separated string of users:
        - This is how the certificate authority limits access, and its only real downside is that a user that has access to account `x` has access to `x` on all hosts goverened by the CA (think, `root`)
- `-I "<IDENTITY>"` instructs `ssh-keygen` to give the certificate the identity `<IDENTITY>`:
    - The `<IDENTITY>` is no different than the `<COMMENT>` set during [SSH keypair generation](#generating-ssh-keypairs):
        - `<IDENTITY>` can be any valid string; but, be sure to create a useful comment
- `-V "-5m:+<PERIOD>w"` instructs `ssh-keygen` to set a time period for which the certificate is valid:
    - `-5m:+<PERIOD>w` will create a certificate that's valid from 5 minutes into the past until the specified number of weeks into the future:
        - `m` is the abbreviation for minutes, and `w` is the unit abbreviation for "weeks"; but, these are not the only units that can be used
- `<PUBKEY_USER>` is the user pubkey that will be combined with `<SIGNING_PRIVATE_KEY>`'s signature:
    - For the user CA certificate, `<PUBKEY_USER>` is the pubkey for the `user-CA_key` keypair
    - For any other user certificate, `<PUBKEY_USER>` is the pubkey for that user's keypair
    - `<PUBKEY_USER>` is the first argument not associated with an option or flag:
        - Because of this, any number of `<PUBKEY_USER>`s can be added to the end of the command, and `ssh-keygen` will sign certificates for all `<PUBKEY_USER>` values passed as arguments.

Conclusion
----------

With this information, any admin team should be able to get started with configuring an SSH certificate authority!
